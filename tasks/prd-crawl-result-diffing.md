# PRD: Crawl Result Differencing (`crawl-result-diffing`)

## 1. Introduction/Overview

This document outlines the requirements for the "Crawl Result Differencing" feature of the MonsterInc tool.

The primary purpose is to compare the list of URLs discovered in the current scan session for a specific root target against the list of URLs discovered in the most recent previous scan session for that same root target. This helps identify new URLs that have appeared and old URLs that are no longer found.

## 2. Goals

*   To identify newly discovered URLs for a given root target compared to its most recent previous scan.
*   To identify URLs that were present in the most recent previous scan but are no longer found in the current scan for a given root target.
*   To integrate these "new" and "old/missing" URL statuses directly into the main HTML report (`httpx-html-reporting`) for easy visualization.
*   To provide a clear indication of asset changes over time at the URL list level.

## 3. User Stories

*   As a security analyst, I want to quickly see which URLs are new or have disappeared since the last scan of a target so I can focus my attention on recent changes to the application's attack surface.
*   As a website administrator, I want to be alerted to URLs that are no longer discoverable after a deployment to ensure no critical content has been unintentionally removed or broken.
*   As a penetration tester, I want the HTML report to highlight new URLs because these often represent recently added functionality that might be less hardened.

## 4. Functional Requirements

1.  **Input Data:**
    *   The primary input is the list of unique, normalized URLs discovered by the `target-crawling` module for the current scan session, for a specific `RootTargetURL`.
    *   The system must be able to retrieve the list of unique, normalized URLs from the most recent previous scan session for the *same* `RootTargetURL`. This historical data will be sourced from the Parquet storage (`httpx-parquet-storage`).
2.  **Identifying Previous Scan:** To find the "most recent previous scan" for a given `RootTargetURL`, the system will look for the latest Parquet file (by `ScanTimestamp` or filename convention) in the `data/YYYYMMDD/` directories that contains results for that specific `RootTargetURL`.
3.  **Comparison Logic:**
    *   The comparison will be based on the normalized URL strings.
    *   **New URLs:** A URL from the current scan is marked as "New" if its normalized form is present in the current scan's URL list but was *not* present in the previous scan's URL list for the same `RootTargetURL`.
    *   **Old/Missing URLs:** A URL from the previous scan is marked as "Old" (or "Missing") if its normalized form was present in the previous scan's URL list but is *not* present in the current scan's URL list for the same `RootTargetURL`.
    *   URLs present in both the current and previous scan lists are considered "Existing" or "Unchanged" in terms of their presence/absence. No further comparison of other attributes (like StatusCode, Title) will be done by *this specific diffing module*.
4.  **Output and Integration with HTML Report:**
    *   The primary output of this diffing process is the status (e.g., "New", "Old", "Existing") for each URL.
    *   This status information must be integrated into the main HTML report generated by `httpx-html-reporting`. For example, a new column "Status" or visual indicators (e.g., color-coding, icons) could be added to the results table in the HTML report.
    *   "Old/Missing" URLs (those found in the previous scan but not the current) should also be listed in a dedicated section of the HTML report, or integrated into the main table with a clear "Old/Missing" status, to show what is no longer present.
5.  **First Scan Handling:** If this is the first time a `RootTargetURL` is being scanned (i.e., no previous Parquet data exists for it), all discovered URLs in the current scan will be implicitly considered "New" (or simply "Existing" without a "New" highlight, as there's no baseline). No "Old/Missing" URLs will be reported.

## 5. Non-Goals (Out of Scope)

*   This feature will *not* compare the content or other attributes (like `StatusCode`, `Title`, `Technologies`) of URLs that exist in both scans. It only focuses on the presence or absence of the URL itself in the discovered list.
*   The feature will not provide a detailed side-by-side diff view of content changes.
*   It will not perform root cause analysis for why URLs have appeared or disappeared.
*   It will not generate a separate diff report file; the diff information is integrated into the main HTML report.

## 6. Design Considerations (Optional)

*   The mechanism for retrieving and parsing the previous scan's URL list from Parquet should be efficient.
*   The visual representation of "New" and "Old/Missing" status in the HTML report should be clear and easily distinguishable.

## 7. Technical Considerations (Optional)

*   Requires read access to Parquet files generated by `httpx-parquet-storage`.
*   Logic to efficiently find the latest relevant Parquet file for a given `RootTargetURL`.
*   Set operations (intersection, difference) on URL lists will be fundamental to the comparison logic.

## 8. Success Metrics

*   The system accurately identifies all "New" URLs in the current scan compared to the most recent previous scan for a given target.
*   The system accurately identifies all "Old/Missing" URLs from the most recent previous scan that are not in the current scan.
*   The "New" and "Old/Missing" statuses are correctly and clearly displayed in the HTML report.
*   The process correctly handles the scenario of a first-time scan for a target.
*   The diffing process is completed efficiently, even with large URL lists from current and previous scans.

## 9. Open Questions

*   In the HTML report, how should "Old/Missing" URLs be displayed? As a separate list, or integrated into the main table with a distinct status and perhaps greyed out details from the last known state? (Assumption: Integrated into the main table if possible, or a clear separate list).
*   If a Parquet file for a previous scan is corrupted or unreadable, how should the system behave? (Assumption: Log an error, and treat the current scan as if it's the first scan for diffing purposes). 