# Package datastore

This package is responsible for handling data storage and retrieval operations, primarily focusing on Parquet file format for scan results.

## Components

### `ParquetReader`

- Reads historical scan data from Parquet files.
- **`NewParquetReader(cfg *config.StorageConfig, logger *log.Logger) *ParquetReader`**: Constructor for `ParquetReader`.
- **`FindHistoricalURLsForTarget(rootTargetURL string) ([]string, error)`**: This is the core method for retrieving historical URL data. It performs the following steps:
    1. Sanitizes the `rootTargetURL` to create a predictable filename (e.g., `example_com_path.parquet`).
    2. Looks for this specific Parquet file directly in the `ParquetBasePath` (configured in `config.StorageConfig`).
    3. If the file exists, it opens and reads the Parquet file.
    4. Skips empty or corrupted files, logging errors.
    5. Extracts `OriginalURL` values from the Parquet rows.
    6. Returns a slice of these URLs. If no file is found or the file is empty, an empty slice is returned (which is not treated as an error, aligning with diffing requirements for a first scan).
- **`FindMostRecentScanURLs(rootTargetURL string) ([]string, error)`**: **DEPRECATED.** This function now directly calls `FindHistoricalURLsForTarget`. Callers should migrate to the new function.

### `ParquetWriter`

- Writes current scan (probe) results to Parquet files.
- **`NewParquetWriter(cfg *config.StorageConfig, appLogger *log.Logger) (*ParquetWriter, error)`**: Constructor for `ParquetWriter`.
- **`Write(probeResults []models.ProbeResult, scanSessionID string, rootTarget string) error`**: Writes a slice of `models.ProbeResult` to a Parquet file.
    - The output filename is generated by sanitizing the `rootTarget` (e.g., `example_com_path.parquet`).
    - The file is placed directly in the `ParquetBasePath`.
    - **Important:** If a file with the same name already exists, it will be **overwritten**. The `scanSessionID` is currently used for logging context but not for filename uniqueness in this writer.
    - `ProbeResult` structs are transformed into `models.ParquetProbeResult` for schema compatibility before writing.

## Data Models

- Utilizes `models.ProbeResult` for current scan data and `models.ParquetProbeResult` for the schema written to/read from Parquet files.

## Configuration

- Relies on `config.StorageConfig` which defines:
    - `ParquetBasePath`: The root directory where Parquet data is stored.
    - `CompressionCodec`: The compression to use for Parquet files (e.g., `zstd`).

## Logging

- Both `ParquetReader` and `ParquetWriter` accept a `log.Logger` instance for logging their operations, including detailed steps, errors encountered, and summaries of data processed.

## Ghi dữ liệu Parquet (sử dụng `parquet-go/parquet-go`)

Thành phần chính là `ParquetWriter`, sử dụng thư viện `github.com/parquet-go/parquet-go` để ghi dữ liệu từ `models.ProbeResult` vào định dạng Parquet.

### Schema

-   Schema cho file Parquet được định nghĩa bởi struct `models.ParquetProbeResult` trong file `internal/models/parquet_schema.go`.
-   Struct này sử dụng các field tags theo quy ước của `parquet-go/parquet-go` (ví dụ: ``parquet:"column_name,optional"``).
-   `parquet-go/parquet-go` tự suy luận schema từ struct và các tags của nó.

### Cách sử dụng

1.  **Khởi tạo `ParquetWriter`**:
    Gọi `NewParquetWriter(cfg *config.StorageConfig, appLogger *log.Logger)`.
    -   `cfg`: Một con trỏ đến `config.StorageConfig`.
    -   `appLogger`: Một logger.
    -   Hàm này sẽ tạo thư mục `ParquetBasePath` nếu nó chưa tồn tại.

2.  **Gọi phương thức `Write()`**:
    `Write(probeResults []models.ProbeResult, scanSessionID string, rootTarget string)`
    -   `probeResults`: Một slice các `models.ProbeResult` cần được ghi.
    -   `scanSessionID`: ID định danh cho phiên quét (chủ yếu dùng cho logging).
    -   `rootTarget`: URL gốc của mục tiêu quét, dùng để tạo tên file.

    Phương thức `Write()` sẽ thực hiện các bước sau:
    -   Nếu `probeResults` rỗng, sẽ ghi log và không tạo file.
    -   Tạo tên file Parquet bằng cách làm sạch `rootTarget` (ví dụ: `example_com.parquet`).
    -   File sẽ được lưu trực tiếp vào `ParquetBasePath`. **File hiện tại (nếu có) sẽ bị ghi đè.**
    -   Chuyển đổi từng `models.ProbeResult` thành `models.ParquetProbeResult`.
    -   Sử dụng `parquet.NewGenericWriter[models.ParquetProbeResult]` để ghi dữ liệu.
    -   Áp dụng thuật toán nén được chỉ định trong `config.StorageConfig.CompressionCodec`.
    -   Ghi log chi tiết.

### Xử lý trường tùy chọn (Optional Fields)

-   Trong `models.ParquetProbeResult`, các trường optional được định nghĩa là con trỏ.
-   `transformToParquetResult` đảm bảo các trường rỗng/nil được xử lý đúng cách.

### Tổ chức file

Các file Parquet sẽ được lưu theo cấu trúc:

```
<ParquetBasePath>/<sanitized_root_target_name>.parquet
```

Ví dụ: `database/example_com.parquet`

### Phụ thuộc

-   `github.com/parquet-go/parquet-go`

Đảm bảo rằng thư viện này được liệt kê chính xác trong file `go.mod` của dự án. 